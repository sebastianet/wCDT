
 <h2> <i class="fa fa-bus"></i> &nbsp; Com fer una consulta &nbsp; <i class="fa fa-bus"></i> </h2>

 <hr>

 <p>
 Entra la data amb format <b>AAAA/MM/DD</b> (exemple : (3) "2014/11/10", (1) "2014/11/09",) i prem el bot&oacute; "Consultar les reserves".

<hr>

<form id="myFormReqDades1Dia">
<table class="tfcon"> <tr> <td>
	<label for="dataReserva">Dia per consultar: </label>
	<input type="text" autofocus value="2014/11/10" name="data_Reserva" /> 
<td>
	<p> Pica aqu&iacute; :
	<input type="submit" value=" Consultar les reserves ">
</table>
</form>

<hr>

<script src="client.js"></script>
<script> 
$(document).ready( function() {
	
	$( "#myFormReqDades1Dia" ).submit( function(event) {
	// will produce a msg as "GET /qui_te_reserves/data_Reserva=2014/12/06" to be sent to the server

		console.log( '[+] boto CONSULTA polsat - get ocupacio de un dia.' ) ;
		
// 1 - get table HTML

		var myDate = $( this ).serialize() ;  // save user entry of this form : [data_Reserva=2014%2F11%2F10]
		var szJustDate = myDate.substring(13) ; // just after the "="
//		szJustDate = unescape ( szJustDate ) ;  // change %2F into "/", old style
		szJustDate = decodeURIComponent ( szJustDate ) ;  // change %2F into "/"

		$.get( '/tbl1day.htm', function( page ) {
			console.log( '**** Demanem al server la taula on posar la ocupacio del dia ['+szJustDate+'].' ) ;
			$( "#content" ).html( page ) ; // show received HTML at specific <div>
			
// 2 - get "dades" for the table

			console.log( '*** consulta - demanem al server la llista de reserves per un dia. Data (%s)', myDate ) ; // output is "data_Reserva=2014/12/06"

// debugger;
			$.get( "/qui_te_reserves/" + myDate, function( dades ) {

				console.log( ">>> consulta - server response : ", dades ); // show whole JSON object
				
				var lng = 0 ;
				lng = dades.length ;
				console.log( '+++ consulta - llargada (%s).', lng ) ;
				if ( lng > 0 ) {
				  var i = 0 ;
				  while ( i < lng ) {
                    var szNom   = dades[i].rnom ;
					var szPista = dades[i].rpista ;
					var szData  = dades[i].rdata ;
					var szHora  = dades[i].rhora ;
					var sz1User = "En {" + szNom + "} te la pista [" + szPista + "] el dia {" + szData + "} a les {" + szHora + "} " ;
					console.log( ">>> consulta - ocupant [%i] : (%s).", i, sz1User ); // 
					
					var szCella = "#tdh"+szHora+"p"+szPista ;  // calculem a quina cella va el texte - veure els noms a sebas.css !
					console.log( ">>> consulta - ocupem la Cella (%s).", szCella ); // debug
					$( szCella ).html( szNom ) ;           // posar el texte a la cella
					$( szCella ).addClass( "ocupada" ) ;   // canviem la class de la cella : afegim "ocupada" ...
					$( szCella ).removeClass( "lliure" ) ; // ... i treiem "lliure"
					i++ ;  // per totes les reserves
				  } ; // while  
				} ; // lng > 0


// +++ codi per associar el event "click" a una cella de la taula

	$('td.lliure').on('click',function(ev){
	  //dia i hora i soci i pista construir serial...
		var target = $(ev.target).parent();
		var targetID = target.attr('id') ;
		console.log( 'consulta - onclick td.lliure - el seu ID es {'+targetID+'}' ) ;
		  
		var clkPrefix = targetID.substring(0,3) ; // tdh10p3
		var clkPista  = targetID.substring(6,7) ; // tdh10p3
		var clkHora   = targetID.substring(3,5) ; // tdh10p3

		if ( clkPrefix == 'tdh' ) {

//			var soci = "Test3" ;
//			var avui = "2014%2F11%2F10" 		

			var avui = $ ('#ocupacio_1_dia>thead>tr>th:nth-child(1)').text() ;
			var soci = window.session.user.nom ;
			avui = encodeURIComponent(avui) ; // convert "/" into "%2F"

			console.log( 'consulta - fer reserva - pfx('+clkPrefix+') - pista '+clkPista+', hora '+clkHora+', soci '+soci+', data '+avui ) ;
			ferReserva( "Nom_Soci="+soci+"&Pista_Reserva="+clkPista+"&Dia_Reserva="+avui+"&Hora_Reserva="+clkHora, "#content" ) ; // client.js

		} else { // wrong prefix
		} ;
		return false ;
 
    }); // OnClick - codi a executar quan piquem TD.LLIURE

	$('td.ocupada').on('click',function(ev){
		var target = $(ev.target).parent();
		var targetID = target.attr('id') ;
		console.log( 'consulta - onclick td.ocupada - el seu ID es {'+targetID+'}' ) ;

		return false ;
 
    }); // OnClick - codi a executar quan piquem TD.OCUPADA

// ---


// posar la data de la reserva al primer quadre dalt a l'esquerra

				$( '#ocupacio_1_dia>thead>tr>th:nth-child(1)' )
				    .css( {'color': 'black', 'vertical-align': 'middle'} )
					.text( szJustDate ) ;

			}); // get(dades)
		
		}) ; // get(table HTML)
		return false ; // stop processing !!!
		
	}); // click "myFormReqDades1Dia" submit


} ) ; // DOM ready
</script>
